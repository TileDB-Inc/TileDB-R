<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>TileDB and (R)MariaDB Examples</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <style type="text/css">
body {
max-width: 50rem;
margin-left: auto;
margin-right: auto;
font-family: system-ui;
}

code {
padding: 2px;
border-radius: unset;
}

pre {
background-color: unset;
border: solid #aaa 1px;
padding: 8px;
}
pre.numberSource {
margin: 0;
padding-left: 0;
}
div.sourceCode {
overflow: visible;
}
pre, pre.sourceCode {
overflow-x: auto;
}
pre>code {
white-space: pre;
overflow: visible;
background-color: unset;
padding: 0;
}
pre.sourceCode.numberSource {
overflow-x: visible;
}
pre.sourceCode.numberSource>code {
white-space: pre-wrap
}
pre.sourceCode.numberSource>code>span {
left: 8px;
text-indent: -4.6em;
}

.chunk-summary {
text-align: right;
}
.chunk-summary+pre,
.chunk-summary+div.sourceCode {
margin-top: 2px;
}

nav > ul {
border: .0625rem solid #444;
border-radius: 4px;
margin: 5px;
padding: 5px;
}
nav ul {
list-style-type: none;
padding-inline-start: 1rem;
}
nav ul li {
padding: 0;
}
nav ul ul {
margin-top: 0;
margin-bottom: 0;
padding-top: 0;
padding-bottom: 0;
}
nav code {
background-color: unset;
color: unset;
}
</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">TileDB and (R)MariaDB Examples</h1>
</header>
<!--
%\VignetteIndexEntry{TileDB RMariaDB Examples}
%\VignetteEngine{simplermarkdown::mdweave_to_html}
%\VignetteEncoding{UTF-8}
-->
<h2 id="introduction">Introduction</h2>
<p><a href="https://www.tiledb.com/">TileDB</a> provides the <em>Universal Data Engine</em> that can be accessed in a variety of ways. The C/C++ library offered by <a href="https://www.tiledb.com/embedded">TileDB Embedded</a> is one approach, and the <a href="https://github.com/TileDB-Inc/TileDB-R">R package</a>, as well as the <a href="https://github.com/TileDB-Inc/TileDB-Py">Python package</a> and other language bindings use it. Another interface is provided by the <a href="https://docs.tiledb.com/mariadb/">MariaDB Integration via the MyTile storage plugin</a>.</p>
<p>This provides TileDB integration with any frontend that interfaces with MariaDB—such as the <a href="https://cran.r-project.org/package=RMariaDB">RMariaDB</a> package for R. So this vignette illustrates the use of TileDB via MariaDB using R and the RMariaDB packages.</p>
<h2 id="installation-or-using-docker">Installation or Using Docker</h2>
<p>In order to use the MyTile storage plugin, one has to compile both the storage plugin itself and the MariaDB server with consistent compiler flags. As the build also requires the TileDB Embedded library and headers, using a Docker container may be easiest. The Dockerfile also provides a concrete example of the build setup.</p>
<p>So here we will use the <a href="https://hub.docker.com/r/tiledb/tiledb-mariadb-r"><code>tiledb/tiledb-mariadb-r</code></a> container.</p>
<h4 id="launch-container-in-background">Launch Container in Background</h4>
<p>We launch the container ‘tiledb/tiledb-mariadb-r’ as a daemon, allowing MariaDB to accept an empty password (using an older MySQL variable setting), and name the running image ‘tiledb-mariadb-r’:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--name</span> tiledb-mariadb-r <span class="at">-it</span> <span class="at">-d</span> <span class="at">--rm</span> <span class="dt">\</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">-e</span> MYSQL_ALLOW_EMPTY_PASSWORD=1 tiledb/tiledb-mariadb-r</span></code></pre></div>
<h4 id="access-container-once-to-write-via-tiledb">Access Container Once to Write via TileDB</h4>
<p>Using the name given to the running instance, we start an R session to write data with TileDB:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> <span class="at">-u</span> root tiledb-mariadb-r R</span></code></pre></div>
<h2 id="examples">Examples</h2>
<h3 id="palmer-penguins">Palmer Penguins</h3>
<p>With the sessions started as in the previous section, we start an R session.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(tiledb)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(palmerpenguins)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> praw <span class="ot">&lt;-</span> penguins_raw</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">fromDataFrame</span>(praw, <span class="st">&quot;/tmp/penguinsraw&quot;</span>)</span></code></pre></div>
<h4 id="access-container-again-to-read-via-rmariadb">Access Container Again to Read via RMariaDB</h4>
<p>In another shell, we can access the container once more and launch another R process:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> <span class="at">-u</span> root tiledb-mariadb-r R</span></code></pre></div>
<p>where we use RMariaDB to access the data via a <code>tibble</code> object and <code>magrittr</code> pipe</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(RMariaDB)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(dplyr, <span class="at">warn.conflicts=</span><span class="cn">FALSE</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(RMariaDB<span class="sc">::</span><span class="fu">MariaDB</span>(), <span class="at">dbname=</span><span class="st">&quot;test&quot;</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">tbl</span>(con, <span class="st">&quot;/tmp/penguinsraw&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">&quot;Length&quot;</span>))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Source:   lazy query [?? x 2]</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Database: mysql [@localhost:NA/test]</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>   <span class="st">`</span><span class="at">Culmen Length (mm)</span><span class="st">`</span> <span class="st">`</span><span class="at">Flipper Length (mm)</span><span class="st">`</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">&lt;</span>dbl<span class="sc">&gt;</span>                 <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a> <span class="dv">1</span>                 <span class="fl">39.1</span>                   <span class="dv">181</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a> <span class="dv">2</span>                 <span class="fl">39.5</span>                   <span class="dv">186</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a> <span class="dv">3</span>                 <span class="fl">40.3</span>                   <span class="dv">195</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a> <span class="dv">4</span>                 <span class="cn">NA</span>                      <span class="cn">NA</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span>                 <span class="fl">36.7</span>                   <span class="dv">193</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span>                 <span class="fl">39.3</span>                   <span class="dv">190</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a> <span class="dv">7</span>                 <span class="fl">38.9</span>                   <span class="dv">181</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a> <span class="dv">8</span>                 <span class="fl">39.2</span>                   <span class="dv">195</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a> <span class="dv">9</span>                 <span class="fl">34.1</span>                   <span class="dv">193</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span>                 <span class="dv">42</span>                     <span class="dv">190</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># ... with more rows</span></span></code></pre></div>
<p>Note that this R session uses TileDB only via the MyTile plugin which is activated implicitly via the ‘table location’ (here <code>/tmp/penguinsraw</code>) of the test database enabling plugins.</p>
<p>Also note that the query is still ‘lazy’: only column names and the first ten observations have been retrieved, and the total size is still unknown as indicated by <code>lazy query [?? x 2]</code>. Adding a <code>collect()</code> verb materialized the full subset.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">tbl</span>(con, <span class="st">&quot;/tmp/penguinsraw&quot;</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>     dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">&quot;Length&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>     <span class="fu">collect</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># A tibble: 344 x 2</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>   <span class="st">`</span><span class="at">Culmen Length (mm)</span><span class="st">`</span> <span class="st">`</span><span class="at">Flipper Length (mm)</span><span class="st">`</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">&lt;</span>dbl<span class="sc">&gt;</span>                 <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a> <span class="dv">1</span>                 <span class="fl">39.1</span>                   <span class="dv">181</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a> <span class="dv">2</span>                 <span class="fl">39.5</span>                   <span class="dv">186</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a> <span class="dv">3</span>                 <span class="fl">40.3</span>                   <span class="dv">195</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a> <span class="dv">4</span>                 <span class="cn">NA</span>                      <span class="cn">NA</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span>                 <span class="fl">36.7</span>                   <span class="dv">193</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span>                 <span class="fl">39.3</span>                   <span class="dv">190</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a> <span class="dv">7</span>                 <span class="fl">38.9</span>                   <span class="dv">181</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a> <span class="dv">8</span>                 <span class="fl">39.2</span>                   <span class="dv">195</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a> <span class="dv">9</span>                 <span class="fl">34.1</span>                   <span class="dv">193</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span>                 <span class="dv">42</span>                     <span class="dv">190</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ... with 334 more rows</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span></span></code></pre></div>
<p>We now see that all 344 rows of this particular result set have been accessed.</p>
<p>Similarly, we can also run summaries on selected column:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">tbl</span>(con, <span class="st">&quot;/tmp/penguinsraw&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>     <span class="fu">group_by</span>(Species) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>     <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;Flipper&quot;</span>),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>                      <span class="fu">list</span>(<span class="sc">~</span><span class="fu">mean</span>(.x, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="sc">~</span><span class="fu">sd</span>(.x, <span class="at">na.rm=</span><span class="cn">TRUE</span>))))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Source:   lazy query [?? x 3]</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Database: mysql [@localhost:NA/test]</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  Species              <span class="st">`</span><span class="at">\</span><span class="st">`</span>Flipper <span class="fu">Length</span> (mm)\<span class="st">`</span><span class="at">_~me~ </span><span class="st">`</span>\<span class="st">`</span><span class="at">Flipper Length (mm)\</span><span class="st">`</span>_<span class="sc">~</span><span class="er">~</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">&lt;</span>chr<span class="sc">&gt;</span>                                        <span class="er">&lt;</span>dbl<span class="sc">&gt;</span>                       <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> Adelie <span class="fu">Penguin</span> (Pyg<span class="sc">~</span>                          <span class="fl">190.</span>                        <span class="fl">6.54</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> Chinstrap <span class="fu">penguin</span> (<span class="sc">~</span>                          <span class="fl">196.</span>                        <span class="fl">7.13</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> Gentoo <span class="fu">penguin</span> (Pyg<span class="sc">~</span>                          <span class="fl">217.</span>                        <span class="fl">6.48</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span></span></code></pre></div>
<h3 id="dbi">DBI</h3>
<p>We can connect directly using the <code>DBI</code> package along with the <code>RMariaDB</code> package and its MyTile bindings:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RMariaDB<span class="sc">::</span><span class="fu">MariaDB</span>(), <span class="at">dbname=</span><span class="st">&quot;test&quot;</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">dbSendQuery</span>(con, <span class="st">&quot;select * from `/work/penguins` as `q91` limit 10&quot;</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">dbFetch</span>(res, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dbClearResult</span>(res)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span></code></pre></div>
<h3 id="s3">S3</h3>
<p>When using Docker, the container setup needs to be modified to include the required AWS access environment variables:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--name</span> tiledb-mariadb-r <span class="dt">\</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">-it</span> <span class="at">-d</span> <span class="at">--rm</span> <span class="dt">\</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">-v</span> <span class="va">$PWD</span>:/work <span class="at">-w</span> /work <span class="dt">\</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">-e</span> MYSQL_ALLOW_EMPTY_PASSWORD=1 <span class="dt">\</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">-e</span> AWS_SECRET_ACCESS_KEY=<span class="va">${AWS_SECRET_ACCESS_KEY}</span> <span class="dt">\</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">-e</span> AWS_ACCESS_KEY_ID=<span class="va">${AWS_ACCESS_KEY_ID}</span> <span class="dt">\</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>       tiledb/tiledb-mariadb-r</span></code></pre></div>
<p>This exports the current working directory (accessed as <code>$PWD</code> in the shell) as <code>/work</code> inside the container (via the <code>-v</code> switch), and instructs the container to start in directory <code>/work</code> (via the <code>-w</code> switch).</p>
<p>In the following example we also set a TileDB configuration option to switch AWS regions.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(dplyr, <span class="at">warn.conflicts=</span><span class="cn">FALSE</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># connect as usual</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(RMariaDB<span class="sc">::</span><span class="fu">MariaDB</span>(), <span class="at">dbname=</span><span class="st">&quot;test&quot;</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># use connection to update config in order to switch s3 regions</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> res1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendQuery</span>(con, <span class="st">&quot;set mytile_tiledb_config=</span><span class="sc">\&quot;</span><span class="st">vfs.s3.region=us-west-1</span><span class="sc">\&quot;</span><span class="st">;&quot;</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(res1)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># run simple query</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> <span class="fu">tbl</span>(con, <span class="st">&quot;s3://tiledb-public-us-west-1/test-array-4x4&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># A tibble: 16 x 3</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>   <span class="st">`</span><span class="at">__dim_0</span><span class="st">`</span> <span class="st">`</span><span class="at">__dim_1</span><span class="st">`</span> <span class="st">`</span><span class="at">__attr</span><span class="st">`</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>int64<span class="sc">&gt;</span>   <span class="er">&lt;</span>int64<span class="sc">&gt;</span>    <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a> <span class="dv">1</span>         <span class="dv">0</span>         <span class="dv">0</span>   <span class="fl">0.397</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a> <span class="dv">2</span>         <span class="dv">0</span>         <span class="dv">1</span>   <span class="fl">0.432</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a> <span class="dv">3</span>         <span class="dv">0</span>         <span class="dv">2</span>   <span class="fl">0.617</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a> <span class="dv">4</span>         <span class="dv">0</span>         <span class="dv">3</span>   <span class="fl">0.403</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span>         <span class="dv">1</span>         <span class="dv">0</span>   <span class="fl">0.837</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span>         <span class="dv">1</span>         <span class="dv">1</span>   <span class="fl">0.670</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a> <span class="dv">7</span>         <span class="dv">1</span>         <span class="dv">2</span>   <span class="fl">0.235</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a> <span class="dv">8</span>         <span class="dv">1</span>         <span class="dv">3</span>   <span class="fl">0.841</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a> <span class="dv">9</span>         <span class="dv">2</span>         <span class="dv">0</span>   <span class="fl">0.222</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span>         <span class="dv">2</span>         <span class="dv">1</span>   <span class="fl">0.468</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="dv">11</span>         <span class="dv">2</span>         <span class="dv">2</span>   <span class="fl">0.970</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="dv">12</span>         <span class="dv">2</span>         <span class="dv">3</span>   <span class="fl">0.551</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="dv">13</span>         <span class="dv">3</span>         <span class="dv">0</span>   <span class="fl">0.628</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="dv">14</span>         <span class="dv">3</span>         <span class="dv">1</span>   <span class="fl">0.0149</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="dv">15</span>         <span class="dv">3</span>         <span class="dv">2</span>   <span class="fl">0.0540</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="dv">16</span>         <span class="dv">3</span>         <span class="dv">3</span>   <span class="fl">0.445</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(con)  <span class="co"># close connection</span></span></code></pre></div>
<h3 id="nyc-taxis">NYC Taxis</h3>
<p>We can write the New York taxi data into TileDB (in the current directory) after reading it as a csv:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> nyc <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;trip_data_1.csv&quot;</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> tiledb<span class="sc">::</span><span class="fu">fromDataFrame</span>(nyc, <span class="st">&quot;trip_data_1&quot;</span>)</span></code></pre></div>
<p>Then we can access it via the path <code>/work/trip_data_1</code> via RMariaDB.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(dplyr, <span class="at">warn.conflicts=</span><span class="cn">FALSE</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(RMariaDB<span class="sc">::</span><span class="fu">MariaDB</span>(), <span class="at">dbname=</span><span class="st">&quot;test&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># list column names</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> <span class="fu">tbl</span>(con, <span class="st">&quot;/work/trip_data_1&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">tbl</span>(con, <span class="st">&quot;/work/trip_data_1&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a> [<span class="dv">1</span>] <span class="st">&quot;__tiledb_rows&quot;</span>      <span class="st">&quot;dropoff_latitude&quot;</span>   <span class="st">&quot;medallion&quot;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a> [<span class="dv">4</span>] <span class="st">&quot;hack_license&quot;</span>       <span class="st">&quot;dropoff_longitude&quot;</span>  <span class="st">&quot;vendor_id&quot;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a> [<span class="dv">7</span>] <span class="st">&quot;rate_code&quot;</span>          <span class="st">&quot;store_and_fwd_flag&quot;</span> <span class="st">&quot;pickup_datetime&quot;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>[<span class="dv">10</span>] <span class="st">&quot;dropoff_datetime&quot;</span>   <span class="st">&quot;trip_time_in_secs&quot;</span>  <span class="st">&quot;pickup_latitude&quot;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>[<span class="dv">13</span>] <span class="st">&quot;passenger_count&quot;</span>    <span class="st">&quot;trip_distance&quot;</span>      <span class="st">&quot;pickup_longitude&quot;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># extract one column (here passenger_count) completely and tabulate in R</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> <span class="fu">tbl</span>(con, <span class="st">&quot;/work/trip_data_1&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(passenger_count) <span class="sc">%&gt;%</span> <span class="fu">collect</span>() <span class="sc">%&gt;%</span> <span class="fu">table</span>()</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>.</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>       <span class="dv">0</span>        <span class="dv">1</span>        <span class="dv">2</span>        <span class="dv">3</span>        <span class="dv">4</span>        <span class="dv">5</span>        <span class="dv">6</span>        <span class="dv">9</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>     <span class="dv">166</span> <span class="dv">10471701</span>  <span class="dv">1986196</span>   <span class="dv">597485</span>   <span class="dv">280992</span>   <span class="dv">920006</span>   <span class="dv">520066</span>        <span class="dv">1</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>     <span class="dv">208</span>      <span class="dv">255</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>       <span class="dv">1</span>        <span class="dv">1</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># alternatively, run a lazy query</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> <span class="fu">tbl</span>(con, <span class="st">&quot;/work/trip_data_1&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(passenger_count) <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="at">nobs =</span> <span class="fu">n</span>())</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Source:   lazy query [?? x 2]</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Database: mysql [@localhost:NA/test]</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>   passenger_count     nobs</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>             <span class="sc">&lt;</span>int<span class="sc">&gt;</span>  <span class="er">&lt;</span>int64<span class="sc">&gt;</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a> <span class="dv">1</span>               <span class="dv">0</span>      <span class="dv">166</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a> <span class="dv">2</span>               <span class="dv">1</span> <span class="dv">10471701</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a> <span class="dv">3</span>               <span class="dv">2</span>  <span class="dv">1986196</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a> <span class="dv">4</span>               <span class="dv">3</span>   <span class="dv">597485</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span>               <span class="dv">4</span>   <span class="dv">280992</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span>               <span class="dv">5</span>   <span class="dv">920006</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a> <span class="dv">7</span>               <span class="dv">6</span>   <span class="dv">520066</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a> <span class="dv">8</span>               <span class="dv">9</span>        <span class="dv">1</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a> <span class="dv">9</span>             <span class="dv">208</span>        <span class="dv">1</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span>             <span class="dv">255</span>        <span class="dv">1</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># here the request is actually sent as SQL and the computation is done in the SQL layer</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> <span class="fu">tbl</span>(con, <span class="st">&quot;/work/trip_data_1&quot;</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>      <span class="fu">group_by</span>(passenger_count) <span class="sc">%&gt;%</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>      <span class="fu">summarize</span>(<span class="at">nobs =</span> <span class="fu">n</span>())     <span class="sc">%&gt;%</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>      <span class="fu">show_query</span>()</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span>SQL<span class="sc">&gt;</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>SELECT <span class="st">`</span><span class="at">passenger_count</span><span class="st">`</span>, <span class="fu">COUNT</span>(<span class="sc">*</span>) AS <span class="st">`</span><span class="at">nobs</span><span class="st">`</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>FROM <span class="st">`</span><span class="at">/work/trip_data_1</span><span class="st">`</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>GROUP BY <span class="st">`</span><span class="at">passenger_count</span><span class="st">`</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># naturally we can also send the query directly to the SQL backend</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> sql <span class="ot">&lt;-</span> <span class="st">&quot;SELECT passenger_count, count(*) AS n FROM `/work/trip_data_1` GROUP BY passenger_count;&quot;</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, sql)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>   passenger_count        n</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>                <span class="dv">0</span>      <span class="dv">166</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>                <span class="dv">1</span> <span class="dv">10471701</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>                <span class="dv">2</span>  <span class="dv">1986196</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>                <span class="dv">3</span>   <span class="dv">597485</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span>                <span class="dv">4</span>   <span class="dv">280992</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span>                <span class="dv">5</span>   <span class="dv">920006</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span>                <span class="dv">6</span>   <span class="dv">520066</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="dv">8</span>                <span class="dv">9</span>        <span class="dv">1</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a><span class="dv">9</span>              <span class="dv">208</span>        <span class="dv">1</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span>             <span class="dv">255</span>        <span class="dv">1</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(con)  <span class="co"># close connection</span></span></code></pre></div>
<h2 id="summary">Summary</h2>
<p>This short vignette demonstrates the use of TileDB-stored data from R using RMariaDB via the MyTile storage extension to MariaBD.</p>
</body>
</html>
