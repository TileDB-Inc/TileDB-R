<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Date Ingestion from SQL: A Commented Example • tiledb</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Date Ingestion from SQL: A Commented Example">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tiledb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.30.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="../articles/introduction.html">First Steps with TileDB</a></li>
    <li><a class="dropdown-item" href="../articles/installation-options.html">Installation Options for the TileDB R Package</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>API</h6></li>
    <li><a class="dropdown-item" href="../articles/documentation.html">TileDB API Documentation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>SQL</h6></li>
    <li><a class="dropdown-item" href="../articles/data-ingestion-from-sql.html">Date Ingestion from SQL: A Commented Example</a></li>
    <li><a class="dropdown-item" href="../articles/tiledb-mariadb-examples.html">TileDB and (R)MariaDB Examples</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/TileDB-Inc/TileDB-R/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Date Ingestion from SQL: A Commented Example</h1>
            
            <h4 data-toc-skip class="date">2022-01-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/TileDB-Inc/TileDB-R/blob/HEAD/vignettes/data-ingestion-from-sql.Rmd" class="external-link"><code>vignettes/data-ingestion-from-sql.Rmd</code></a></small>
      <div class="d-none name"><code>data-ingestion-from-sql.Rmd</code></div>
    </div>

    
    
<!--
%\VignetteIndexEntry{Data Ingestion from SQL}
%\VignetteEngine{simplermarkdown::mdweave_to_html}
%\VignetteEncoding{UTF-8}
-->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><a href="https://www.tiledb.com/" class="external-link">TileDB</a> provides the
<em>Universal Data Engine</em> that can be accessed in a variety of
ways. Users sometimes wonder how to transfer data from existing
databases. This short vignettes shows an example relying on the <a href="https://cran.r-project.org/package=DBI" class="external-link">DBI</a> package for R. It
offers a powerful and convenient abstraction layer on top a number of
database backends with connection packages that adhere to, and utilise,
the DBI framework. Some examples are the packages (listed in
alphabetical order) <a href="https://cran.r-project.org/package=duckdb" class="external-link">duckdb</a>, <a href="https://cran.r-project.org/package=RClickhouse" class="external-link">RClickhouse</a>,
<a href="https://cran.r-project.org/package=RGreenplum" class="external-link">RGreenplum</a>,
<a href="https://cran.r-project.org/package=RJDBC" class="external-link">RJDBC</a>, <a href="https://cran.r-project.org/package=RMariaDB" class="external-link">RMariaDB</a>, <a href="https://cran.r-project.org/package=RMySQL" class="external-link">RMySQL</a>, <a href="https://cran.r-project.org/package=ROracle" class="external-link">ROracle</a>, <a href="https://cran.r-project.org/package=RPostgres" class="external-link">RPostgres</a>, <a href="https://cran.r-project.org/package=RPostgreSQL" class="external-link">RPostgreSQL</a>,
<a href="https://cran.r-project.org/package=RPresto" class="external-link">RPresto</a>, <a href="https://cran.r-project.org/package=RRedshiftSQL" class="external-link">RRedshiftSQL</a>,
<a href="https://cran.r-project.org/package=RSQLite" class="external-link">RSQLite</a>, and
many more as seen via the <a href="https://cran.r-project.org/package=DBI" class="external-link">CRAN page</a>.</p>
<p>We provide a simple example using <a href="https://cran.r-project.org/package=RPostgreSQL" class="external-link">RPostgreSQL</a>
and an existing database of historical stockmarket price data.</p>
</div>
<div class="section level2">
<h2 id="load-required-packages">Load Required Packages<a class="anchor" aria-label="anchor" href="#load-required-packages"></a>
</h2>
<p>The basic setup is straightforward. We load the required package <a href="https://cran.r-project.org/package=RPostgreSQL" class="external-link">RPostgreSQL</a>
which in turn imports <a href="https://cran.r-project.org/package=DBI" class="external-link">DBI</a> as well as <a href="https://cran.r-project.org/package=tiledb" class="external-link">tiledb</a>. We use <a href="https://cran.r-project.org/package=data.table" class="external-link">data.table</a> for
its print method, the <a href="https://cran.r-project.org/package=tibble" class="external-link">tibble</a> package
offers an alternative):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tomoakin/RPostgreSQL" class="external-link">RPostgreSQL</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/TileDB-Inc/TileDB-R" class="external-link">tiledb</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="connect-to-database">Connect to Database<a class="anchor" aria-label="anchor" href="#connect-to-database"></a>
</h2>
<p>This step uses the DBI abstraction. A compliant backend driver can be
loaded via <code>dbDriver</code>, and a connection can be established
via <code>dbConnect</code> using appropriate arguments
<code>dbname</code>, <code>user</code>, <code>password</code>,
<code>host</code>, and <code>port</code>, as needed, with proper
dispatching the implementation provided by the driver. The details
depend on the chosen backend, this can be as simple as
<code>con &lt;- dbConnect(RSQLite::SQLite(), ":memory:")</code> in the
case of <a href="https://cran.r-project.org/package=RSQLite" class="external-link">RSQLite</a>
and an in-memory (and likely transient) database.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## a local SQL db we have here -- about 617k rows</span></span>
<span><span class="va">dbSetup</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">drv</span> <span class="op">&lt;-</span> <span class="fu">dbDriver</span><span class="op">(</span><span class="st">"PostgreSQL"</span><span class="op">)</span></span>
<span>    <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="va">drv</span>,</span>
<span>                     user<span class="op">=</span><span class="st">"...omitted..."</span>,</span>
<span>                     password<span class="op">=</span><span class="st">"...omitted..."</span>, <span class="co"># Could use e.g. Sys.getenv("DB_PASSWD")</span></span>
<span>                     dbname<span class="op">=</span><span class="st">"...omitted..."</span><span class="op">)</span></span>
<span>    <span class="va">con</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fetch-data">Fetch Data<a class="anchor" aria-label="anchor" href="#fetch-data"></a>
</h2>
<p>In the next step we fetch the data—and for simplicity issue just one
<code>select</code> statement returning a single <code>data.frame</code>
(or here a <code>data.table</code> variant). In larger-than-memory
settings the SQL query could easily bucket by symbols, or date range, or
…</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">getDataFromSQL</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbSetup</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">sql</span> <span class="op">&lt;-</span> <span class="st">"select * from stockprices order by symbol, date;"</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">con</span>, <span class="va">sql</span><span class="op">)</span></span>
<span>    <span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>                          <span class="co"># create data.table</span></span>
<span>    <span class="va">res</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="writing-data-to-tiledb">Writing Data to TileDB<a class="anchor" aria-label="anchor" href="#writing-data-to-tiledb"></a>
</h2>
<p>Having read the data into memory we can use the TileDB R function
<code>fromDataFrame</code>. It has numerous option to configure, as well
as sensible defaults (to for example enable ZSTD compression). Here we
select the first two columns for symbol and data as dimensions. Symbols,
being text, do not set a domain set. For the date we set two ‘safe’
outer values for the range.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">storeDataTDB</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">uri</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/fromDataFrame.html">fromDataFrame</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">uri</span>,</span>
<span>                  col_index<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,</span>
<span>                  tile_domain<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>date<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"1985-01-01"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                          <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2030-12-31"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>mode="append"</code> argument of <code>fromDataFrame</code>
can be used to append to an existing array to support chunked
operation.</p>
<div class="section level3">
<h3 id="reading-data-back-in">Reading Data Back In<a class="anchor" aria-label="anchor" href="#reading-data-back-in"></a>
</h3>
<p>Reading data from TileDB is a very standard operation of opening the
URI, possibly specifying the return type and possibly subsetting by
dimension values, or attributes. Here, for simplicity, we just read
everything.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">getDataTDB</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">uri</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/save_allocation_size_preference.html">set_allocation_size_preference</a></span><span class="op">(</span><span class="fl">1e7</span><span class="op">)</span> <span class="co"># larger than local default value</span></span>
<span>    <span class="va">arr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tiledb_array.html">tiledb_array</a></span><span class="op">(</span><span class="va">uri</span>, return_as<span class="op">=</span><span class="st">"data.frame"</span><span class="op">)</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">arr</span><span class="op">[</span><span class="op">]</span></span>
<span>    <span class="va">res</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">uri</span> <span class="op">&lt;-</span> <span class="st">"/tmp/tiledb/beancounter"</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">getDataFromSQL</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span><span class="fu">storeData</span><span class="op">(</span><span class="va">dat</span>, <span class="va">uri</span><span class="op">)</span></span>
<span><span class="va">chk</span> <span class="op">&lt;-</span> <span class="fu">getDataTDB</span><span class="op">(</span><span class="va">uri</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">chk</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Done!\n"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="see-also">See Also<a class="anchor" aria-label="anchor" href="#see-also"></a>
</h2>
<p>The vignette <a href="tiledb-mariadb-examples.html">TileDB MariaDB
Examples</a> shows to use MariaDB via the MyTile integration of TileDB
as a direct backend.</p>
<p>The <a href="https://dirk.eddelbuettel.com/papers/useR2021_tiledb_tutorial.pdf" class="external-link">TileDB
R Tutorial at useR! 2021</a> contained a worked example of writing
<em>much</em> larger data set in chunks. The process is very similar to
the simple example we showed here – and in addition requires a suffient
domain range for the dimension along with a (sequential or parallel)
loop of reading chunks and writing them to TileDB.</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This vignette provides a commented walk-through of a worked example
of a SQL-to-TileDB data ingestion.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://tiledb.com" class="external-link"><img src="https://github.com/TileDB-Inc/TileDB/raw/dev/doc/source/_static/tiledb-logo_color_no_margin_@4x.png" height="24"></a>, Dirk Eddelbuettel, Isaiah Norton.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
